<html>
	<head>
		<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
 		<script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

 		<style>
 			#map {
 				height: 540px;

 			}
 		</style>
	</head>
	<body>
		<h1>My eBird Analyzer</h1>
		<div id="map"></div>
		<script>
			$(document).ready(function() {
				var map = L.map('map').setView([39.73, -104.99], 4);

				L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
	    		attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
				}).addTo(map);


				$.ajax({
					url: './data/test_data.csv',
					method: 'GET',
					dataType: 'text',
					success: function(data) {
						var parsedData = parseData(data);
						addDataToMap(parsedData);
					}
				});

				function parseData(data) {
					var rows = $.trim(data).split('\n');
					var headers = rows[0].split(',');

					//find the indices of some fields we want to get data out of:
					var latIndex = headers.indexOf('Latitude');
					var lonIndex = headers.indexOf('Longitude');
					var locationNameIndex = headers.indexOf('Location');

					rows.shift(1); //remove headers row;

					var objArray = [];
					var LocationNameList = [];
					//convert each row into an object
					$(rows).each(function(i, row) {
						//THIS NEEDS TO HANDLE STRINGS WITH COMMAS IN THEM, eg.:
						// "Race Point Beach, Provincetown"
						var splitRow = row.split(',');
						var location = splitRow[locationNameIndex]

						//skip locations that are already processed.
						if(LocationNameList.indexOf(location) === -1) {
							LocationNameList.push(location);

							var point = {
								type: 'Feature',
								properties: {
									name: splitRow[locationNameIndex]
								},
								geometry: {
									type: 'Point',
									coordinates: [ parseFloat(splitRow[lonIndex]), parseFloat(splitRow[latIndex]) ];
								}
							};
							objArray.push(point);
						}
					});

					return objArray;
				};

				function addDataToMap(data) {
					var locationsLayer = L.geoJson(data,{
						onEachFeature: addPopupContent
					}).addTo(map);

				};
				function addPopupContent(feature, layer) {
					layer.bindPopup('<p>' + feature.properties.name + '</p>')
				}
			});
		</script>
	</body>
</html>